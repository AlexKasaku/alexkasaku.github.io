<!DOCTYPE html>
<html>
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Kasaku">
    <title>A RequiresDataSource filter for Sitecore Controller Renderings - Kasaku</title>
    <meta name="author" content="Alex Washtell">
    <meta name="description" content="Kasaku">
    <link rel="icon" href="/assets/images/favicon.png">
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="atom.xml">
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style.min.css" type="text/css">
    <!--STYLES END-->
    
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-63800320-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>

    <body>
        <div id="blog">
            <header id="header">
    <i id="btn-open-sidebar" class="icon-lg icon-bars "></i>
    <h1 class="header-title">
        <a class="header-title-link" href="http://kasaku.local">Kasaku</a>
    </h1>
    
</header>
            <nav id="sidebar">
    
    
    <div class="sidebar-logo">
        <h1><span class="rotate">Kasaku</span></h1>
        <h2>Web Development</h2>
    </div>
    
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link" href="http://kasaku.local/">
                    
                    <i class="sidebar-button-icon icon-lg icon-home"></i>
                    <span class="sidebar-button-desc hide-md">Home</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link" href="http://kasaku.local/all-tags">
                    
                    <i class="sidebar-button-icon icon-lg icon-tags"></i>
                    <span class="sidebar-button-desc hide-md">Tags</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link" href="http://kasaku.local/all-archives">
                    
                    <i class="sidebar-button-icon icon-lg icon-archive"></i>
                    <span class="sidebar-button-desc hide-md">Archives</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
            <a  class="sidebar-button-link" href="https://community.sitecore.net/members/alexwashtell_5f00_911378316" target="_blank">
                
                    <i class="sidebar-button-icon icon-lg icon-sitecore"></i>
                    <span class="sidebar-button-desc hide-md">Sitecore</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
            <a  class="sidebar-button-link" href="https://github.com/kasaku" target="_blank">
                
                    <i class="sidebar-button-icon icon-lg icon-github"></i>
                    <span class="sidebar-button-desc hide-md">GitHub</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
            <a  class="sidebar-button-link" href="https://twitter.com/kasaku_dev" target="_blank">
                
                    <i class="sidebar-button-icon icon-lg icon-twitter"></i>
                    <span class="sidebar-button-desc hide-md">Twitter</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
            <a  class="sidebar-button-link" href="https://stackoverflow.com/users/173983/kasaku" target="_blank">
                
                    <i class="sidebar-button-icon icon-lg icon-stack-overflow"></i>
                    <span class="sidebar-button-desc hide-md">Stack Overflow</span>
                </a>
        </li>
        
        <li class="sidebar-button">
            
            <a  class="sidebar-button-link" href="mailto://mail@kasaku.co.uk" target="_blank">
                
                    <i class="sidebar-button-icon icon-lg icon-envelope-o"></i>
                    <span class="sidebar-button-desc hide-md">Mail</span>
                </a>
        </li>
        
    </ul>
    
    <ul class="sidebar-buttons">
        
        <li class="sidebar-button">
            
                <a  class="sidebar-button-link" href="http://kasaku.local/atom.xml">
                    
                    <i class="sidebar-button-icon icon-lg icon-rss"></i>
                    <span class="sidebar-button-desc hide-md">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>
            <div id="main">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
        <div class="post-header main-content-wrap">
    
        <h1 class="post-title" itemprop="headline">A RequiresDataSource filter for Sitecore Controller Renderings</h1>
    
    <div class="post-meta">
    <time  itemprop="datePublished" content="Thu Nov 13 2014 22:59:55 GMT+0000">
        Nov 13, 2014
    </time>
    
</div>
</div>
    
    <div class="post-content markdown main-content-wrap" itemprop="articleBody">
        <p>A common requirement when creating components in Sitecore is for the component to rely on data being supplied via the DataSource. Whilst you can try your best to ensure that a DataSource is associated with a component, there will inevitably be occasions when that DataSource gets deleted or moved and ultimately isn’t provided to the component at the time of rendering.<br><a id="more"></a><br>What can work well in these occasions is to provide the content editor with some feedback that the component won’t function correctly, so that they know they shouldn’t publish the page in its current state.</p>
<p>In Sitecore Controller Renderings, this could be done through some code at the top of each rendering action, checking for a DataSource and acting accordingly if one wasn’t found. However, rather than write repetitve code in each rendering, a better method is to make use of a reusable <a href="http://msdn.microsoft.com/en-us/library/dd410209%28v=vs.100%29.aspx" target="_blank" rel="external">ActionFilter</a>.</p>
<p>When the ActionFilter is executed, it attempts to locate a DataSource within the current RenderingContext. If no DataSource is found, then a PartialView is returned and the action will not continue to execute.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">public class RequiresDataSource : FilterAttribute, IActionFilter</span><br><span class="line">&#123;</span><br><span class="line">  private const string DefaultNoDataSourceView = "_NoDataSource";</span><br><span class="line">  </span><br><span class="line">  protected Item DataSourceItem &#123; get; set; &#125;</span><br><span class="line">  </span><br><span class="line">  public virtual void OnActionExecuting(ActionExecutingContext filterContext)</span><br><span class="line">  &#123;</span><br><span class="line">    DataSourceItem = GetDataSourceItem();</span><br><span class="line">    </span><br><span class="line">    if (DataSourceItem == null)</span><br><span class="line">    &#123;</span><br><span class="line">      filterContext.Result = new PartialViewResult</span><br><span class="line">      &#123;</span><br><span class="line">        ViewName = NoDataSourceView ?? DefaultNoDataSourceView</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  private Item GetDataSourceItem()</span><br><span class="line">  &#123;</span><br><span class="line">    if (RenderingContext.Current == null || RenderingContext.Current.Rendering == null || </span><br><span class="line">        string.IsNullOrEmpty(RenderingContext.Current.Rendering.DataSource))</span><br><span class="line">    &#123;</span><br><span class="line">       return null;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    // A DataSource has at least been set. Now to find out if it is an actual item.</span><br><span class="line">    return Sitecore.Context.Database.GetItem(RenderingContext.Current.Rendering.DataSource);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  public void OnActionExecuted(ActionExecutedContext filterContext)</span><br><span class="line">  &#123;</span><br><span class="line">    // Not required.</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  public string NoDataSourceView &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With this attribute created, you can assign it to an action:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[RequiresDataSource]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">HomepageCarousel</span>(<span class="params"></span>)</span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="comment">// Controller rendering code goes here...</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> PartialView();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>You can also assign it to a controller if you want it to execute for <strong>every</strong> action within that controller.</p>
<p>If you don’t specify a view, the default will be used. However, if you need to specify a particular view for a given rendering, you can:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RequiresDataSource(NoDataSourceView=<span class="string">"_NoDataSourceCustom"</span>)]</span><br></pre></td></tr></table></figure>
<p>What do you put in the view? That is completly up to what is necessary in your solution - however a good strategy is to provide a simple error message to a user using the PageEditor, but actually render nothing if the component still makes it to the published page without a DataSource:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@if (PageMode.IsPageEditor)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="tag">&lt;<span class="title">div</span> <span class="attribute">class</span>=<span class="value">"error"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">h1</span>&gt;</span>Heads up!<span class="tag">&lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">p</span>&gt;</span>This component requires a DataSource but one has not been specified.</span><br><span class="line">    If this page is published in its current state, this component will be empty.<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, if the component is viewed within the Page Editor, and no DataSource has been set, the user will see an informative message:</p>
<p><img src="/2014/11/13/a-requiresdatasource-filter-for-sitecore-controller-renderings/DS_Required.png" alt="No DataSource example" title="No DataSource example"></p>

<p>As well as provided the user with some feedback, it has removed the need for the null-checking that would have otherwise been required in the action to prevent exceptions, we’re now guaranteed that the code will only be executed if a DataSource has been set.</p>
<h3 id="Extending_the_attribute">Extending the attribute</h3><p>To provide the user with some more specific feedback, and also to ensure that our code only executes if the <strong>correct</strong> type of DataSource has been applied, we can extend the attribute to create another.</p>
<p>The <code>RequiresDataSourceOfTemplate</code> attribute shown below adds an additional check that occurs <em>if</em> the DataSource has been set, whereupon it additionally confirms that the DataSource is of the right template:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RequiresDataSourceOfTemplate</span> : <span class="title">RequiresDataSource</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">string</span> DefaultInvalidDataSourceView = <span class="string">"_InvalidDataSource"</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">readonly</span> Guid _templateId;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">RequiresDataSourceOfTemplate</span>(<span class="params">Guid templateId</span>)</span><br><span class="line">  </span>&#123;</span><br><span class="line">    _templateId = templateId;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnActionExecuting</span>(<span class="params">ActionExecutingContext filterContext</span>)</span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnActionExecuting(filterContext);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Only continue if we have a datasource, i.e. the base action didn't result in anything.</span></span><br><span class="line">    <span class="keyword">if</span> (DataSourceItem != <span class="keyword">null</span> &amp;&amp; !DataSourceItem.DerivesFromTemplate(_templateId))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">var</span> correctTemplateItem = Sitecore.Context.Database.GetItem(_templateId.ToID());</span><br><span class="line">      </span><br><span class="line">      filterContext.Result = <span class="keyword">new</span> PartialViewResult</span><br><span class="line">      &#123;</span><br><span class="line">        ViewData = &#123; </span><br><span class="line">          &#123;<span class="string">"RequiredTemplateName"</span>, correctTemplateItem.Name &#125;, </span><br><span class="line">          &#123;<span class="string">"FoundTemplateName"</span>, DataSourceItem.TemplateName&#125; </span><br><span class="line">        &#125;,</span><br><span class="line">        ViewName = InvalidDataSourceView ?? DefaultInvalidDataSourceView</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">string</span> InvalidDataSourceView &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This time, as well as returning an alternate view, some additional metadata is pushed into the ViewData. That allows us to provde create a view that provides the user with a bit of information about what went wrong:</p>
<p><img src="/2014/11/13/a-requiresdatasource-filter-for-sitecore-controller-renderings/DS_Invalid.png" alt="Invalid DataSource example" title="Invalid DataSource example"></p>

<p>Once you have these attributes, you can decorate all of your actions that rely on DataSources with them. This will eliminate a lot of common code needing to be rewritten across these actions, so instead your actions can focus on just delivering the right content with the correct DataSources in place.</p>

        
            
        
    </div>
    <div class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/sitecore/">sitecore</a> <a class="tag tag--primary tag--small t-link" href="/tags/sitecore-mvc/">sitecore-mvc</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/12/04/a-removelink-command-for-pageditor/"  data-tooltip="A RemoveLink command for PageEditor">
                
                    <i class="icon-angle-left"></i>
                    <span class="hide-xs hide-sm text-small mg-icon-l">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <span class="hide-xs hide-sm text-small mg-icon-r">NEXT</span>
                    <i class="icon-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://kasaku.local/2014/11/13/a-requiresdatasource-filter-for-sitecore-controller-renderings/">
                <i class="icon-google-plus"></i>
            </a>
        </li>
        <li class="post-action">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://kasaku.local/2014/11/13/a-requiresdatasource-filter-for-sitecore-controller-renderings/">
                <i class="icon-facebook-official"></i>
            </a>
        </li>
        <li class="post-action">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://kasaku.local/2014/11/13/a-requiresdatasource-filter-for-sitecore-controller-renderings/">
                <i class="icon-twitter"></i>
            </a>
        </li>
    </ul>
</div>


        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2015 Alex Washtell. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div class="post-bottom-bar">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2014/12/04/a-removelink-command-for-pageditor/"  data-tooltip="A RemoveLink command for PageEditor">
                
                    <i class="icon-angle-left"></i>
                    <span class="hide-xs hide-sm text-small mg-icon-l">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--disabled">
                
                    <span class="hide-xs hide-sm text-small mg-icon-r">NEXT</span>
                    <i class="icon-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://kasaku.local/2014/11/13/a-requiresdatasource-filter-for-sitecore-controller-renderings/">
                <i class="icon-google-plus"></i>
            </a>
        </li>
        <li class="post-action">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://kasaku.local/2014/11/13/a-requiresdatasource-filter-for-sitecore-controller-renderings/">
                <i class="icon-facebook-official"></i>
            </a>
        </li>
        <li class="post-action">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://kasaku.local/2014/11/13/a-requiresdatasource-filter-for-sitecore-controller-renderings/">
                <i class="icon-twitter"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
            
        </div>
        <div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="icon-remove"></i>
        </div>
        
            <h4 id="about-card-name">Alex Washtell</h4>
        
        
        
    </div>
</div>
        <div id="cover" style="background-image:url('/assets/images/undefined');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/assets/js/script.min.js" type="text/javascript"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'kasaku';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>


</html>